<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Wayfarer pano helper</title>
    <style>
      .nomination-map {
        height: 40vh;
        width: 100%;
      }
      .prevent-interactions {
        pointer-events: none;
      }
      .set-location-button-wrapper {
        padding: 10px;
        text-align: center;
      }
      .set-location-button {
        padding: 0 10px;
        background-color: #4CAF50; /* Green */
        border: none;
        color: white;
        text-align: center;
        text-decoration: none;
        display: inline-block;
        font-size: 16px;
        min-height: 5vh;
        line-height: 20px;
        /* border: 2px solid black; */
      }
      .nomination-category-header {
        padding: 10px;
        text-align: center;
        font-weight: bold;
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <div class="set-location-button-wrapper">
      <button class="set-location-button" onclick="setMyLocation()">
        Установить маркер на моё местоположение
      </button>
    </div>
    <div class="nomination-category-header">
      Здесь перетаскиванием устанавливается местоположение маркера:
    </div>
    <div id="map" class="nomination-map"></div>
    <div class="nomination-category-header">
      Здесь видно - будет ли подхватываться панорама в wayfarer и где будет на ней маркер:
    </div>
    <div id="pano" class="nomination-map prevent-interactions"></div>
    

    <script src="https://maps.googleapis.com/maps/api/js?client=gme-nianticinc"></script>
    <script>
      var map;
      var default_coords = {lat: 44.61865914513468, lng: 40.10605591534423};
      var infoWindow = new google.maps.InfoWindow();
      var placemark = new google.maps.LatLng(default_coords.lat, default_coords.lng);
      var mapMarker;
      var panoMap;
      var panoMarker;
      var panorama;

      function setMyLocation() {
        // Try HTML5 geolocation.
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            function (position) {
              var pos = {
                lat: position.coords.latitude,
                lng: position.coords.longitude,
              };
              console.log(pos);
              // infoWindow.setPosition(pos);
              // infoWindow.setContent('Location found.');
              // infoWindow.open(map);
              // map.setCenter(pos);
              var point = new google.maps.LatLng(
                position.coords.latitude,
                position.coords.longitude
              );
              mapMarker.setPosition(point);
              map.panTo(point);

              setStreetView(
                position.coords.latitude,
                position.coords.longitude
              );
            },
            function () {
              handleLocationError(true, infoWindow, map.getCenter());
            }
          );
        } else {
          // Browser doesn't support Geolocation
          handleLocationError(false, infoWindow, map.getCenter());
        }
      }
      function handleLocationError(browserHasGeolocation, infoWindow, pos) {
        infoWindow.setPosition(pos);
        infoWindow.setContent(
          browserHasGeolocation
            ? "Error: The Geolocation service failed."
            : "Error: Your browser doesn't support geolocation."
        );
        infoWindow.open(map);
      }

      function initialize() {
        var mapOptions = {
          zoom: 20,
          center: placemark,
          mapTypeId: "satellite",
        };

        map = new google.maps.Map(document.getElementById("map"), mapOptions);

        mapMarker = new google.maps.Marker({
          map: map,
          draggable: true, //перетаскивание маркера
          animation: google.maps.Animation.DROP, //анимация маркера
          position: placemark,
        });

        google.maps.event.addListener(mapMarker, "dragend", function (event) {
          var lat = mapMarker.getPosition().lat();
          var lng = mapMarker.getPosition().lng();
          console.log(lat + "," + lng); //выводим в консоль браузера новые координаты
          setStreetView(lat, lng);
        });

        setStreetView(default_coords.lat, default_coords.lng);
      }

      google.maps.event.addDomListener(window, "load", initialize);

      function setStreetView(lat, lng) {
        // var lat = nomCtrl.currentNomination.lat;
        // var lng = nomCtrl.currentNomination.lng;
        console.log("setStreetView", lat, lng);

        if (!panoMap) {
          panoMap = new google.maps.Map(document.getElementById("pano"), {
            center: {
              lat: lat,
              lng: lng,
            },
            mapTypeId: "hybrid",
            zoom: 17,
            scaleControl: true,
            scrollwheel: true,
          });
          panoMarker = new google.maps.Marker({
            map: panoMap,
            position: {
              lat: parseFloat(lat),
              lng: parseFloat(lng),
            },
            title: "title",
          });
          panorama = panoMap.getStreetView();
        } else {
          panoMarker.setPosition(new google.maps.LatLng(lat, lng));
        }
        var client = new google.maps.StreetViewService();

        var d = map.getZoom();
        var e = Math.max(50, 35 * Math.pow(2, 16 - d));
        console.log("e", e);

        client.getPanoramaByLocation(
          {
            lat: lat,
            lng: lng,
          },
          e,
          function (result, status) {
            console.log(result);
            var point = new google.maps.LatLng(lat, lng);
            if (status === "OK") {
              var oldPoint = point;
              point = result.location.latLng;
              var heading = google.maps.geometry.spherical.computeHeading(
                point,
                oldPoint
              );
              panorama.setPosition(point);
              panorama.setPov({
                heading: heading,
                pitch: 0,
                zoom: 1,
              });
              panorama.setVisible(true);
            } else {
              panorama.setPosition(point);
              panoMap.panTo(point);
            }
          }
        );
      }
    </script>
  </body>
</html>
